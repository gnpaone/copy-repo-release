name: Bump Version

on:
  workflow_dispatch:
    inputs:
      bump_type:
        description: "Select version bump type"
        required: true
        default: "patch"
        type: choice
        options:
          - patch
          - minor
          - major

jobs:
  bump:
    runs-on: ubuntu-latest

    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Fix git permissions
        run: |
          sudo chown -R $USER:$USER .
          sudo chmod -R u+w .git

      - name: Find latest tag of target repo
        id: tag
        uses: oprypin/find-latest-tag@v1
        with:
          repository: gnpaone/copy-repo-release
          releases-only: true

      - name: Strip 'v' from tag
        id: version
        run: |
          RAW_TAG="${{ steps.tag.outputs.tag }}"
          CLEAN_TAG="${RAW_TAG#v}"      # remove leading v
          echo "clean_version=$CLEAN_TAG" >> $GITHUB_OUTPUT

      - name: Bump version
        id: bump
        run: |
          OLD="${{ steps.version.outputs.clean_version }}"
          PART="${{ github.event.inputs.bump_type }}"

          IFS='.' read -r MAJ MIN PATCH <<< "$OLD"

          case "$PART" in
            major)
              MAJ=$((MAJ + 1))
              MIN=0
              PATCH=0
              ;;
            minor)
              MIN=$((MIN + 1))
              PATCH=0
              ;;
            patch)
              PATCH=$((PATCH + 1))
              ;;
          esac

          NEW="$MAJ.$MIN.$PATCH"
          echo "new_version=$NEW" >> $GITHUB_OUTPUT
          echo "Bumped version: $OLD â†’ $NEW"

      - name: Update version in README.md
        id: updatever
        uses: gnpaone/dynamic-update-readme@v1.0.2
        with:
          readme_path: README.md
          marker_text: "COPY_RELEASE_WORKFLOW"
          markdown_text: |
            ```yaml
            name: Copy Release

            on:
              workflow_dispatch:
                inputs:
                  tag:
                    description: "Release tag to copy"
                    required: true

            jobs:
              copy-release:
                runs-on: ubuntu-latest
                steps:
                  - name: Copy GitHub Release
                    uses: gnpaone/copy-repo-release@v${{ steps.bump.outputs.new_version }}
                    with:
                      source_repo: my-org/source-repo
                      tag: ${{ github.event.inputs.tag }}
            ```
            
            ---
            
            ## ðŸ”§ Example: Overriding Fields
            
            ```yaml
            - name: Copy with Overrides
              uses: gnpaone/copy-repo-release@v${{ steps.bump.outputs.new_version }}
              with:
                source_repo: user/project-A
                destination_repo: user/project-B
                github_token: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
                override_name: "Rebranded Release Name"
                override_body: |
                  This release is synced but modified.
                  It has a multi-line description.
                override_draft: "true"
                skip_assets: "true"
            ```
          commit_message: "Update version to v${{ steps.bump.outputs.new_version }}"
          confirm_and_push: false

      - name: Update version in build.sbt
        run: |
          VERSION="${{ steps.bump.outputs.new_version }}"
          echo "Updating build.sbt version â†’ $VERSION"

          sed -i "s/^version := \".*\"/version := \"${VERSION}\"/" build.sbt

      - name: Create PR
        id: cpr
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "${{ steps.updatever.outputs.commit_message }}"
          committer: gnpaone <78990165+gnpaone@users.noreply.github.com>
          author: gnpaone <78990165+gnpaone@users.noreply.github.com>
          branch: bump-version
          base: master
          delete-branch: true
          title: Bump version

      - name: Enable pull request automerge
        if: steps.cpr.outputs.pull-request-operation == 'created'
        uses: peter-evans/enable-pull-request-automerge@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          pull-request-number: ${{ steps.cpr.outputs.pull-request-number }}

      - name: Delete PRs head branch
        if: steps.cpr.outputs.pull-request-operation == 'created'
        uses: dawidd6/action-delete-branch@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          numbers: ${{ steps.cpr.outputs.pull-request-number }}
